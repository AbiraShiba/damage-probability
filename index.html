<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>ãƒ€ãƒ¡è¨ˆ(For è¶…ãƒ’ãƒãƒªè«–)</title>
  <style>
    .param-block {
      border: 1px solid #ccc;
      padding: 15px;
      margin: 10px 0;
    }

    /* ã“ã“ã‚’è¿½åŠ  â†’ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ–ãƒ­ãƒƒã‚¯å†…ã®å…¥åŠ›æ¬„ã‚’æ¨ªé•·ã« */
    .param-block input[type="text"],
    .param-block input[type="number"] {
      width: 260px;
      /* å¥½ããªå¹…ã«èª¿æ•´ã—ã¦ãã ã•ã„ */
      box-sizing: border-box;
    }

    /* é–¾å€¤ãƒ€ãƒ¡ãƒ¼ã‚¸ã¨ä¸Šä½ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆç”¨ã®å…¥åŠ›æ¬„ã‚‚å°‘ã—åºƒã’ã‚‹ */
    #input-threshold {
      width: 200px;
      box-sizing: border-box;
    }

    #input-percent {
      width: 80px;
      box-sizing: border-box;
    }
  </style>
  <!-- çŠ¶æ…‹ã‚’åœ§ç¸®ã™ã‚‹ãŸã‚ã® LZString -->
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
</head>

<body>
  <h1>ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—æ©Ÿï¼ˆæ¤è‘‰ã‚ã³ã‚‰ï¼ è¶…ãƒ’ãƒãƒªè«–ï¼‰</h1>

  <p>
    version 1.1.1 (Updated: 2025/11/17)
  </p>

  <p>
    ä¸‹è¨˜ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã€ã€Œè¨ˆç®—ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚<br>
    ï¼ˆğŸ“’ä½¿ã„æ–¹ã¯ãƒšãƒ¼ã‚¸ã®ä¸‹ã«ã‚ã‚Šã¾ã™ï¼‰
  </p>

  <div id="param-container"></div>

  <button id="add-param-btn"> + ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ </button>

  <hr>

  <div>
    <!-- é–¾å€¤ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ã‚«ãƒ³ãƒå¯¾å¿œã—ãŸã„ã®ã§ type="text" ã«å¤‰æ›´ -->
    <label>é–¾å€¤ãƒ€ãƒ¡ãƒ¼ã‚¸: <input id="input-threshold" type="text" value="42,000,000"></label><br>
    <label>ä¸Šä½ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆ [%]: <input id="input-percent" type="number" value="5"></label><br>
    <button id="calc-btn">è¨ˆç®—ã™ã‚‹</button>
  </div>

  <h2>çµæœ</h2>
  <div id="result">ã¾ã è¨ˆç®—ã—ã¦ã„ã¾ã›ã‚“ã€‚</div>

  <!-- Pyodide -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.0/full/pyodide.js"></script>

  <script>
    // æ•°å€¤ã®å…±é€šãƒ˜ãƒ«ãƒ‘
    function parseNumberWithComma(str) {
      if (typeof str !== "string") return NaN;
      return parseFloat(str.replace(/,/g, ""));
    }

    function formatNumberWithComma(num) {
      if (typeof num !== "number" || !isFinite(num)) return "";
      return num.toLocaleString();
    }

    // --- URL ãƒãƒƒã‚·ãƒ¥ã¸ã®ä¿å­˜ï¼å¾©å…ƒï¼ˆLZ åœ§ç¸®ç‰ˆï¼‰ ---
    function loadStateFromUrl() {
      const hash = window.location.hash;
      if (!hash || !hash.startsWith("#s=")) {
        return null;
      }
      const encoded = hash.slice(3);
      try {
        // åœ§ç¸®ã•ã‚ŒãŸæ–‡å­—åˆ—ã‚’å±•é–‹
        const json = LZString.decompressFromEncodedURIComponent(encoded);
        if (!json) {
          throw new Error("decompress failed");
        }
        return JSON.parse(json);
      } catch (e) {
        console.error("URL ã‹ã‚‰ã®çŠ¶æ…‹å¾©å…ƒã«å¤±æ•—:", e);
        return null;
      }
    }

    function saveStateToUrl(state) {
      try {
        const json = JSON.stringify(state); // threshold, percent, params(åå‰è¾¼ã¿), resultHtml ã‚’ã¾ã¨ã‚ã¦ä¿å­˜
        // JSON ã‚’åœ§ç¸®ã—ã¦ URL ç”¨ã®å®‰å…¨ãªæ–‡å­—åˆ—ã«å¤‰æ›
        const compressed = LZString.compressToEncodedURIComponent(json);
        const newHash = "#s=" + compressed;
        // ãƒ‘ã‚¹ã¨ã‚¯ã‚¨ãƒªã¯ç¶­æŒã—ã¤ã¤ãƒãƒƒã‚·ãƒ¥ã ã‘æ›´æ–°
        const newUrl = window.location.pathname + window.location.search + newHash;
        history.replaceState(null, "", newUrl);
      } catch (e) {
        console.error("URL ã¸ã®çŠ¶æ…‹ä¿å­˜ã«å¤±æ•—:", e);
      }
    }

    // --- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å…¥åŠ›ãƒ–ãƒ­ãƒƒã‚¯ UI ç”Ÿæˆ ---
    function addParamBlock(defaults = null) {
      const container = document.getElementById("param-container");

      const block = document.createElement("div");
      block.className = "param-block";

      block.innerHTML = `
        <label>åå‰ï¼š
          <input type="text" class="name"
            value="${defaults && defaults.name !== undefined ? defaults.name : ''}"
            placeholder="ä¾‹: ãƒ’ãƒãƒª(1å›ç›®)">
        </label>
        <br>

        <label><input type="checkbox" class="use-flag"
          ${defaults && defaults.use === false ? "" : "checked"}> ä½¿ç”¨</label>
        <button class="del-btn"> - å‰Šé™¤</button><br>

        <label>Normal-range: <input type="text" class="s-range"
          value="${defaults && defaults.s !== undefined ? defaults.s : ''}"
          placeholder="967,012 - 1,238,906"></label><br>

        <label>Critical-range: <input type="text" class="c-range"
          value="${defaults && defaults.c !== undefined ? defaults.c : ''}"
          placeholder="4,455,692 - 5,483,561"></label><br>

        <label>Crittical[%]:
          <input type="number" class="crit-percent" step="0.01"
          value="${defaults && defaults.p !== undefined ? defaults.p : 65}">
        </label><br>

        <label>Repeat:
          <input type="number" class="repeat" step="1"
          value="${defaults && defaults.r !== undefined ? defaults.r : 1}">
        </label><br>
      `;

      block.querySelector(".del-btn").onclick = () => block.remove();

      container.appendChild(block);
    }

    document.getElementById("add-param-btn").onclick = () => addParamBlock();

    // --- ãƒšãƒ¼ã‚¸åˆæœŸåŒ–ï¼šURL ã‹ã‚‰çŠ¶æ…‹å¾©å…ƒ ---
    function restoreState() {
      const state = loadStateFromUrl();
      if (!state) {
        // çŠ¶æ…‹ãŒãªã‘ã‚Œã° 1 ã‚»ãƒƒãƒˆã ã‘å‡ºã™
        addParamBlock();
        return;
      }

      // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆname, use, s, c, p, r ã‚’ defaults ã¨ã—ã¦æ¸¡ã™ï¼‰
      if (Array.isArray(state.params) && state.params.length > 0) {
        state.params.forEach(p => addParamBlock(p));
      } else {
        addParamBlock();
      }

      // é–¾å€¤ãƒ»ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆ
      if (typeof state.threshold === "number") {
        // ã‚«ãƒ³ãƒä»˜ãè¡¨ç¤º
        document.getElementById("input-threshold").value =
          formatNumberWithComma(state.threshold);
      }
      if (typeof state.percent === "number") {
        document.getElementById("input-percent").value = state.percent;
      }

      // çµæœ
      if (typeof state.resultHtml === "string") {
        document.getElementById("result").innerHTML = state.resultHtml;
      }
    }

    restoreState();

    // --- å…¥åŠ›ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«å…¨é¸æŠ (text ã¨ number ä¸¡æ–¹) ---
    document.addEventListener("focusin", (e) => {
      const el = e.target;
      if (el.tagName === "INPUT" && (el.type === "text" || el.type === "number")) {
        setTimeout(() => el.select(), 0);
      }
    });

    // --- Pyodide ãƒ­ãƒ¼ãƒ‰ ---
    let pyodideReadyPromise = (async () => {
      const pyodide = await loadPyodide();
      await pyodide.loadPackage("scipy");

      // --- Python ã‚³ãƒ¼ãƒ‰ ---
      const pythonCode = `
import numpy as np
from scipy.signal import fftconvolve

NUM_VALUE = 20000

def make_pdf(x_array, a_s_bound, a_s, a_c_bound, a_c, perc_c):
    pdf = np.zeros_like(x_array, dtype=float)
    condition_s = (a_s_bound <= x_array) & (x_array <= a_s)
    condition_c = (a_c_bound <= x_array) & (x_array <= a_c)
    height_s = 1.0 / (a_s - a_s_bound)
    height_c = 1.0 / (a_c - a_c_bound)
    p_c = perc_c / 100.0
    pdf += p_c * condition_c * height_c
    pdf += (1.0 - p_c) * condition_s * height_s
    return pdf

def convolve_pdf_once(x1, pdf1, x2, pdf2):
    dx = float(x1[1] - x1[0])
    conv = fftconvolve(pdf1, pdf2, mode="full") * dx
    x_start = float(x1[0])
    x = x_start + np.arange(conv.size) * dx
    return x, conv

def make_pdf_list(x_array, params):
    return [make_pdf(x_array, p["a_s_bound"], p["a_s"],
                     p["a_c_bound"], p["a_c"], p["crit_percent"])
            for p in params]

def convolve_pdf_list(x_array, pdf_list):
    x_conv = x_array
    pdf_conv = pdf_list[0]
    for next_pdf in pdf_list[1:]:
        x_conv, pdf_conv = convolve_pdf_once(x_conv, pdf_conv, x_array, next_pdf)
    return x_conv, pdf_conv

def pdf_to_cdf(x, p):
    dx = float(x[1] - x[0])
    c = np.cumsum(p) * dx
    return np.clip(c / c[-1], 0, 1)

def add_param_string(params, s_range, c_range, p, repeat):
    def parse_range(r):
        a, b = r.split('-')
        return int(a.replace(',', '').strip()), int(b.replace(',', '').strip())
    a, b = parse_range(s_range)
    ac, bc = parse_range(c_range)
    for _ in range(int(repeat)):
        params.append({
            "a_s_bound": a, "a_s": b,
            "a_c_bound": ac, "a_c": bc,
            "crit_percent": p
        })
    return params

def get_cdf_from_params(param_list):
    params = []
    for (s_range, c_range, p, repeat) in param_list:
        add_param_string(params, s_range, c_range, p, repeat)

    val_max = max(p["a_c"] for p in params) + 1.0
    x_array = np.linspace(0, val_max, NUM_VALUE)

    pdf_list = make_pdf_list(x_array, params)
    x_conv, pdf_conv = convolve_pdf_list(x_array, pdf_list)
    c_conv = 1.0 - pdf_to_cdf(x_conv, pdf_conv)
    return x_conv, c_conv

def compute_all(param_list, threshold, percent):
    x_conv, c_conv = get_cdf_from_params(param_list)

    prob = float(np.interp(threshold, x_conv, c_conv)) * 100.0

    cdf = 1.0 - c_conv
    target = 1.0 - percent * 0.01
    thr = float(np.interp(target, cdf, x_conv))

    return prob, thr
      `;
      await pyodide.runPythonAsync(pythonCode);
      return pyodide;
    })();


    // --- è¨ˆç®—ãƒœã‚¿ãƒ³ ---
    document.getElementById("calc-btn").onclick = async () => {
      // é–¾å€¤ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ã‚«ãƒ³ãƒé™¤å»ã—ã¦æ•°å€¤åŒ–
      const thresholdStr = document.getElementById("input-threshold").value;
      const threshold = parseNumberWithComma(thresholdStr);
      const percent = parseFloat(document.getElementById("input-percent").value);

      if (isNaN(threshold) || isNaN(percent)) {
        document.getElementById("result").innerText =
          "é–¾å€¤ãƒ€ãƒ¡ãƒ¼ã‚¸ã¨é–¾å€¤ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
        return;
      }

      const paramBlocks = document.querySelectorAll(".param-block");

      const param_list = [];
      const saved_params = [];

      // ãƒ–ãƒ©ã‚¦ã‚¶ UI â†’ Python ã® param_list ï¼‹ URLä¿å­˜ç”¨ params ã«å¤‰æ›
      paramBlocks.forEach(block => {
        const use = block.querySelector(".use-flag").checked;

        const name = block.querySelector(".name").value;
        const s_range = block.querySelector(".s-range").value;
        const c_range = block.querySelector(".c-range").value;
        const crit = parseFloat(block.querySelector(".crit-percent").value);
        const repeat = parseInt(block.querySelector(".repeat").value);

        // URL ä¿å­˜ç”¨ï¼ˆname ã‚‚å«ã‚ã‚‹ï¼‰
        saved_params.push({
          use: use,
          name: name,
          s: s_range,
          c: c_range,
          p: isNaN(crit) ? null : crit,
          r: isNaN(repeat) ? null : repeat
        });

        if (!use) {
          return; // æœªä½¿ç”¨ãƒ–ãƒ­ãƒƒã‚¯ã¯è¨ˆç®—ã«å…¥ã‚Œãªã„
        }

        // åå‰ã¯è¨ˆç®—ã«é–¢ä¿‚ãªã„ã®ã§ param_list ã«ã¯å…¥ã‚Œãªã„
        if (s_range && c_range && !isNaN(crit) && !isNaN(repeat)) {
          param_list.push([s_range, c_range, crit, repeat]);
        }
      });

      if (param_list.length === 0) {
        document.getElementById("result").innerText =
          "æœ‰åŠ¹ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ï¼ˆå…¨ã¦æœªä½¿ç”¨ã‹ã€å…¥åŠ›ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼‰";
        return;
      }

      try {
        const pyodide = await pyodideReadyPromise;

        pyodide.globals.set("js_params", param_list);
        pyodide.globals.set("js_threshold", threshold);
        pyodide.globals.set("js_percent", percent);

        const result = pyodide.runPython(`
prob, thr = compute_all(js_params, js_threshold, js_percent)
(prob, thr)
        `).toJs();

        const [prob, thr] = result;

        const resultHtml =
          "P(ãƒ€ãƒ¡ãƒ¼ã‚¸ â‰¥ " + formatNumberWithComma(threshold) + ") = " + prob.toFixed(2) + " %<br>" +
          "ç¢ºç‡ " + percent + " % ã§å‡ºã›ã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸: " + formatNumberWithComma(Math.round(thr));

        document.getElementById("result").innerHTML = resultHtml;

        const state = {
          threshold: threshold,   // æ•°å€¤ã¨ã—ã¦ä¿å­˜ï¼ˆå¾©å…ƒæ™‚ã« toLocaleString ã™ã‚‹ï¼‰
          percent: percent,
          params: saved_params,   // â˜… å„ãƒ–ãƒ­ãƒƒã‚¯ã® name ã‚‚å«ã‚ã¦ä¿å­˜
          resultHtml: resultHtml
        };
        saveStateToUrl(state);
      } catch (e) {
        console.error(e);
        document.getElementById("result").innerText =
          "è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
      }
    };
  </script>


  <h2>ğŸ“’ ä½¿ã„æ–¹</h2>

  <p>
    ï¼ˆâ€»ã“ã®è¨ˆç®—æ©Ÿã¯ãƒ‰ãƒ’ãƒŠã‚„ãƒŸã‚«ã®ã‚ˆã†ãªç‰¹æ®Šãªè¨ˆç®—ã«ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ï¼‰
  </p>

  <p>
    äº‹å‰ã«ã€ã‚­ãƒ£ãƒ©ã®ãƒ€ãƒ¡ãƒ¼ã‚¸æœ€å°å€¤ï¼ˆä¸‹é™ï¼‰ã¨æœ€å¤§å€¤ï¼ˆä¸Šé™ï¼‰ã‚’
    ã€Œä½•ã‚‰ã‹ã®æ‰‹æ®µã€ã§æº–å‚™ã—ã¦ãã ã•ã„ã€‚
  </p>

  <p>
    å…¥åŠ›æ¬„ã«ã¯æ¬¡ã®å½¢å¼ã§è¨˜å…¥ã—ã¾ã™ï¼š
  </p>

  <ul>
    <li><code>ä¸‹é™ - ä¸Šé™</code>ï¼ˆãƒã‚¤ãƒ•ãƒ³åŒºåˆ‡ã‚Šï¼‰</li>
    <li><code>967,012 - 1,238,906</code> ã®ã‚ˆã†ã«ã‚«ãƒ³ãƒå…¥ã‚Šã§ã‚‚å¯</li>
    <li>åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ãŒã‚ã£ã¦ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“</li>
  </ul>

  <p>
    Normal-range ã¨ Critical-range ã®ä¸¡æ–¹ã‚’ã€åŒã˜å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
  </p>

  <p>
    <strong>Critical[%]</strong> ã¯ä¼šå¿ƒç‡ã‚’å…¥åŠ›ã—ã¾ã™ã€‚<br>
    ä¾‹ï¼š65% ãªã‚‰ <code>65</code>
  </p>

  <p>
    <strong>Repeat</strong> ã¯åŒã˜æ”»æ’ƒã‚’ä½•å›ç¹°ã‚Šè¿”ã™ã‹ã‚’æŒ‡å®šã—ã¾ã™ã€‚<br>
    ä¾‹ï¼šãã®ç”Ÿå¾’ãŒã€Œ2 ç™ºæ’ƒã¤ã€ãªã‚‰ <code>Repeat = 2</code>
  </p>

  <p>
    è¤‡æ•°ã®æ”»æ’ƒãŒã‚ã‚‹å ´åˆã¯ã€Œ+ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ ã€ã§è¿½åŠ ã§ãã¾ã™ã€‚
  </p>
</body>

</html>
