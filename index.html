<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>BA ダメージ分布 計算機 (Pyodide)</title>
  <style>
    .param-block {
      border: 1px solid #ccc;
      padding: 10px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>BA ダメージ分布 計算機</h1>

  <p>下記のパラメータを入力し、「計算」を押してください。</p>

  <div id="param-container"></div>

  <button id="add-param-btn">＋ パラメータを追加</button>

  <hr>

  <div>
    <label>閾値ダメージ: <input id="input-threshold" type="number" value="42000000"></label><br>
    <label>上位パーセント [%]: <input id="input-percent" type="number" value="5"></label><br>
    <button id="calc-btn">計算する</button>
  </div>

  <h2>結果</h2>
  <div id="result">まだ計算していません。</div>

  <!-- Pyodide -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.0/full/pyodide.js"></script>

  <script>
    // --- URL ハッシュへの保存／復元 ---
    function loadStateFromUrl() {
      const hash = window.location.hash;
      if (!hash || !hash.startsWith("#s=")) {
        return null;
      }
      const encoded = hash.slice(3);
      try {
        const json = decodeURIComponent(encoded);
        return JSON.parse(json);
      } catch (e) {
        console.error("URL からの状態復元に失敗:", e);
        return null;
      }
    }

    function saveStateToUrl(state) {
      try {
        const json = JSON.stringify(state);
        const encoded = encodeURIComponent(json);
        const newHash = "#s=" + encoded;
        // パスとクエリは維持しつつハッシュだけ更新
        const newUrl = window.location.pathname + window.location.search + newHash;
        history.replaceState(null, "", newUrl);
      } catch (e) {
        console.error("URL への状態保存に失敗:", e);
      }
    }

    // --- パラメータ入力ブロック UI 生成 ---
    function addParamBlock(defaults=null) {
      const container = document.getElementById("param-container");

      const block = document.createElement("div");
      block.className = "param-block";

      block.innerHTML = `
        <label><input type="checkbox" class="use-flag"
          ${defaults && defaults.use === false ? "" : "checked"}> 使用</label>
        <button class="del-btn">− 削除</button><br>
        
        <label>Normal-range: <input type="text" class="s-range"
          value="${defaults && defaults.s !== undefined ? defaults.s : ''}"
          placeholder="967,012 - 1,238,906"></label><br>

        <label>Critical-range: <input type="text" class="c-range"
          value="${defaults && defaults.c !== undefined ? defaults.c : ''}"
          placeholder="4,455,692 - 5,483,561"></label><br>

        <label>Crittical[%]:
          <input type="number" class="crit-percent" step="0.01"
          value="${defaults && defaults.p !== undefined ? defaults.p : 65}">
        </label><br>

        <label>Repeat:
          <input type="number" class="repeat" step="1"
          value="${defaults && defaults.r !== undefined ? defaults.r : 1}">
        </label><br>
      `;

      block.querySelector(".del-btn").onclick = () => block.remove();

      container.appendChild(block);
    }

    document.getElementById("add-param-btn").onclick = () => addParamBlock();

    // --- ページ初期化：URL から状態復元 ---
    function restoreState() {
      const state = loadStateFromUrl();
      if (!state) {
        // 状態がなければ 1 セットだけ出す
        addParamBlock();
        return;
      }

      // パラメータブロック
      if (Array.isArray(state.params) && state.params.length > 0) {
        state.params.forEach(p => addParamBlock(p));
      } else {
        addParamBlock();
      }

      // 閾値・パーセント
      if (typeof state.threshold === "number") {
        document.getElementById("input-threshold").value = state.threshold;
      }
      if (typeof state.percent === "number") {
        document.getElementById("input-percent").value = state.percent;
      }

      // 結果
      if (typeof state.resultHtml === "string") {
        document.getElementById("result").innerHTML = state.resultHtml;
      }
    }

    restoreState();

    // --- 入力フォーカス時に全選択（text入力だけ） ---
    document.addEventListener("focusin", (e) => {
      const el = e.target;
      if (el.tagName === "INPUT" && el.type === "text") {
        setTimeout(() => el.select(), 0);
      }
    });

    // --- Pyodide ロード ---
    let pyodideReadyPromise = (async () => {
      const pyodide = await loadPyodide();
      await pyodide.loadPackage("scipy");

      // --- Python コード ---
      const pythonCode = `
import numpy as np
from scipy.signal import fftconvolve

NUM_VALUE = 20000

def make_pdf(x_array, a_s_bound, a_s, a_c_bound, a_c, perc_c):
    pdf = np.zeros_like(x_array, dtype=float)
    condition_s = (a_s_bound <= x_array) & (x_array <= a_s)
    condition_c = (a_c_bound <= x_array) & (x_array <= a_c)
    height_s = 1.0 / (a_s - a_s_bound)
    height_c = 1.0 / (a_c - a_c_bound)
    p_c = perc_c / 100.0
    pdf += p_c * condition_c * height_c
    pdf += (1.0 - p_c) * condition_s * height_s
    return pdf

def convolve_pdf_once(x1, pdf1, x2, pdf2):
    dx = float(x1[1] - x1[0])
    conv = fftconvolve(pdf1, pdf2, mode="full") * dx
    x_start = float(x1[0])
    x = x_start + np.arange(conv.size) * dx
    return x, conv

def make_pdf_list(x_array, params):
    return [make_pdf(x_array, p["a_s_bound"], p["a_s"],
                     p["a_c_bound"], p["a_c"], p["crit_percent"])
            for p in params]

def convolve_pdf_list(x_array, pdf_list):
    x_conv = x_array
    pdf_conv = pdf_list[0]
    for next_pdf in pdf_list[1:]:
        x_conv, pdf_conv = convolve_pdf_once(x_conv, pdf_conv, x_array, next_pdf)
    return x_conv, pdf_conv

def pdf_to_cdf(x, p):
    dx = float(x[1] - x[0])
    c = np.cumsum(p) * dx
    return np.clip(c / c[-1], 0, 1)

def add_param_string(params, s_range, c_range, p, repeat):
    def parse_range(r):
        a, b = r.split('-')
        return int(a.replace(',', '').strip()), int(b.replace(',', '').strip())
    a, b = parse_range(s_range)
    ac, bc = parse_range(c_range)
    for _ in range(int(repeat)):
        params.append({
            "a_s_bound": a, "a_s": b,
            "a_c_bound": ac, "a_c": bc,
            "crit_percent": p
        })
    return params

def get_cdf_from_params(param_list):
    params = []
    for (s_range, c_range, p, repeat) in param_list:
        add_param_string(params, s_range, c_range, p, repeat)

    val_max = max(p["a_c"] for p in params) + 1.0
    x_array = np.linspace(0, val_max, NUM_VALUE)

    pdf_list = make_pdf_list(x_array, params)
    x_conv, pdf_conv = convolve_pdf_list(x_array, pdf_list)
    c_conv = 1.0 - pdf_to_cdf(x_conv, pdf_conv)
    return x_conv, c_conv

def compute_all(param_list, threshold, percent):
    x_conv, c_conv = get_cdf_from_params(param_list)

    prob = float(np.interp(threshold, x_conv, c_conv)) * 100.0

    cdf = 1.0 - c_conv
    target = 1.0 - percent * 0.01
    thr = float(np.interp(target, cdf, x_conv))

    return prob, thr
      `;
      await pyodide.runPythonAsync(pythonCode);
      return pyodide;
    })();


    // --- 計算ボタン ---
    document.getElementById("calc-btn").onclick = async () => {
      const threshold = parseFloat(document.getElementById("input-threshold").value);
      const percent = parseFloat(document.getElementById("input-percent").value);

      const paramBlocks = document.querySelectorAll(".param-block");

      const param_list = [];
      const saved_params = [];

      // ブラウザ UI → Python の param_list ＋ URL保存用 params に変換
      paramBlocks.forEach(block => {
        const use = block.querySelector(".use-flag").checked;

        const s_range = block.querySelector(".s-range").value;
        const c_range = block.querySelector(".c-range").value;
        const crit = parseFloat(block.querySelector(".crit-percent").value);
        const repeat = parseInt(block.querySelector(".repeat").value);

        saved_params.push({
          use: use,
          s: s_range,
          c: c_range,
          p: isNaN(crit) ? null : crit,
          r: isNaN(repeat) ? null : repeat
        });

        if (!use) {
          return; // 未使用ブロックは計算に入れない
        }

        if (s_range && c_range && !isNaN(crit) && !isNaN(repeat)) {
          param_list.push([s_range, c_range, crit, repeat]);
        }
      });

      const pyodide = await pyodideReadyPromise;

      pyodide.globals.set("js_params", param_list);
      pyodide.globals.set("js_threshold", threshold);
      pyodide.globals.set("js_percent", percent);

      const result = pyodide.runPython(`
prob, thr = compute_all(js_params, js_threshold, js_percent)
(prob, thr)
      `).toJs();

      const [prob, thr] = result;

      const resultHtml =
        "P(V ≥ " + threshold.toLocaleString() + ") = " + prob.toFixed(2) + " %<br>" +
        "上位 " + percent + " % に入る閾値: " + Math.round(thr).toLocaleString();

      document.getElementById("result").innerHTML = resultHtml;

      const state = {
        threshold: threshold,
        percent: percent,
        params: saved_params,
        resultHtml: resultHtml
      };
      saveStateToUrl(state);
    };
  </script>
</body>
</html>
